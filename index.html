<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Browser</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #e2e8f0;
        }

        #header {
            position: fixed;
            top: 0;
            left: 450px;
            right: 0;
            height: 80px;
            background: #2d3748;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #header h1 {
            margin: 0;
            font-weight: 300;
            letter-spacing: 1px;
        }

        #sidebar {
            width: 450px;
            height: 100vh;
            background-color: white;
            padding: 20px;
            border-right: 1px solid #e2e8f0;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            margin-top: 80px;
        }

        .filter-section {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0,0,0,0.05);
        }

        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .filter-header h5 {
            color: #4a5568;
            font-weight: 500;
        }

        .time-range {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .movie-card {
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            height: auto;
            display: flex;
            flex-direction: column;
            color: #4a5568;
            font-family: 'Georgia', serif;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            background: white;
            position: relative;
            min-height: 250px;
        }

        .movie-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        .movie-card-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .movie-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: #2d3748;
            flex: 1;
            margin-right: 20px;
        }

        .movie-description {
            font-size: 0.9rem;
            line-height: 1.4;
            color: #681ee0;
            flex: 1;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .movie-details {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .movie-info {
            flex: 1;
        }

        .movie-runtime {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .movie-genres-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .movie-genres {
            color: #718096;
        }

        .movie-cast {
            flex: 1;
            text-align: right;
            position: absolute;
            bottom: 55px;
            right: 20px;
            max-width: 50%;
        }

        .movie-cast-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .movie-cast-list {
            color: #718096;
        }

        .showtime-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
            position: relative;
            z-index: 1;
            margin-top: auto;
            padding-top: 15px;
        }

        .showtime-button {
            background-color: #805ad5;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: transform 0.2s ease, background-color 0.2s ease;
        }

        .showtime-button:hover {
            background-color: #6b46c1;
            transform: translateY(-2px);
        }

        .ticket-counter {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ticket-counter button {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: none;
            background: #4a5568;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .ticket-counter button:hover {
            background: #718096;
        }

        .ticket-counter span {
            min-width: 30px;
            text-align: center;
            font-weight: 500;
        }

        .scrollable-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 10px;
            background-color: #f7fafc;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
        }

        .form-check-input:checked {
            background-color: #4a5568;
            border-color: #4a5568;
        }

        .btn-primary {
            background-color: #4a5568;
            border-color: #4a5568;
        }

        .btn-primary:hover {
            background-color: #718096;
            border-color: #718096;
        }

        .form-select:focus, .form-control:focus {
            border-color: #718096;
            box-shadow: 0 0 0 0.25rem rgba(74, 85, 104, 0.25);
        }

        .btn-danger {
            background-color: #e53e3e;
            border-color: #e53e3e;
        }

        .btn-danger:hover {
            background-color: #c53030;
            border-color: #c53030;
        }

        .btn-secondary {
            background-color: #718096;
            border-color: #718096;
        }

        .btn-secondary:hover {
            background-color: #4a5568;
            border-color: #4a5568;
        }

        .buttons-container {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-submit {
            background-color: #4299e1;
            border-color: #4299e1;
            color: white;
        }

        .btn-submit:hover {
            background-color: #3182ce;
            border-color: #3182ce;
        }

        .time-picker {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .time-picker select {
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            background-color: white;
            padding: 5px;
        }

        .time-picker .hour-select, .time-picker .minute-select {
            width: 60px;
        }

        .time-picker .ampm-select {
            width: 70px;
        }
        
        .time-input {
            display: flex;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }
        
        .time-field {
            border: none;
            outline: none;
            padding: 6px 8px;
            width: 85px;
            text-align: center;
        }
        
        .ampm-toggle {
            border: none;
            padding: 0 8px;
            background-color: #f1f5f9;
            cursor: pointer;
            font-weight: 500;
            min-width: 45px;
            color: #4a5568;
            transition: background-color 0.2s ease;
        }
        
        .ampm-toggle:hover {
            background-color: #e2e8f0;
        }
        
        .ampm-toggle.active {
            background-color: #4a5568;
            color: white;
        }
    </style>
    <!-- One required script -->
    <script src="https://dhcs-s25-bakeoff3.glitch.me/framework.js"></script>
</head>
<body>
    <div id="sidebar">
        <div class="filter-section">
            <div class="filter-header">
                <h5>Feature Filters</h5>
                <div style="display: flex; align-items: center; width: 140px; position: relative;">
                    <span class="small" style="position: absolute; left: 0;">Include</span>
                    <div style="margin: 0 auto;">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="featureToggle">
                        </div>
                    </div>
                    <span class="small" style="position: absolute; right: 0;">Exclude</span>
                </div>
            </div>
            <select class="form-select mb-3" id="featureSelect">
                <option value="genre">Genre</option>
                <option value="actors">Actors</option>
            </select>
            <div class="scrollable-list" id="includeList">
                <!-- Sample include items -->
                <div class="checkbox-item">
                    <input type="checkbox" class="form-check-input" id="genre1" checked>
                    <label class="form-check-label" for="genre1">Action</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" class="form-check-input" id="genre2">
                    <label class="form-check-label" for="genre2">Comedy</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" class="form-check-input" id="genre3" checked>
                    <label class="form-check-label" for="genre3">Drama</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" class="form-check-input" id="genre4">
                    <label class="form-check-label" for="genre4">Sci-Fi</label>
                </div>
            </div>
            <div class="scrollable-list mt-2" id="excludeList">
                <!-- Sample exclude items -->
                <div class="checkbox-item">
                    <input type="checkbox" class="form-check-input" id="exclude1">
                    <label class="form-check-label" for="exclude1">Horror</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" class="form-check-input" id="exclude2" checked>
                    <label class="form-check-label" for="exclude2">Romance</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" class="form-check-input" id="exclude3">
                    <label class="form-check-label" for="exclude3">Documentary</label>
                </div>
            </div>
        </div>

        <div class="filter-section">
            <h5>Time Filters</h5>
            <div id="timeRanges">
                <div class="time-range">
                    <div class="time-input">
                        <input type="text" class="time-field" pattern="([1-9]|1[0-2]):[0-5][0-9]" placeholder="From">
                        <button class="ampm-toggle active" data-period="PM">PM</button>
                    </div>
                    <span>to</span>
                    <div class="time-input">
                        <input type="text" class="time-field" value="8:00" pattern="([1-9]|1[0-2]):[0-5][0-9]" placeholder="To">
                        <button class="ampm-toggle active" data-period="PM">PM</button>
                    </div>
                    <button class="btn btn-danger btn-sm">×</button>
                </div>
                <div class="time-range">
                    <div class="time-input">
                        <input type="text" class="time-field" value="10:00" pattern="([1-9]|1[0-2]):[0-5][0-9]" placeholder="From">
                        <button class="ampm-toggle active" data-period="AM">AM</button>
                    </div>
                    <span>to</span>
                    <div class="time-input">
                        <input type="text" class="time-field" pattern="([1-9]|1[0-2]):[0-5][0-9]" placeholder="To">
                        <button class="ampm-toggle" data-period="PM">PM</button>
                    </div>
                    <button class="btn btn-danger btn-sm">×</button>
                </div>
            </div>
            <button class="btn btn-secondary btn-sm mt-2">Add Time Range</button>
        </div>

        <div class="filter-section">
            <h5>Runtime Filter</h5>
            <div class="d-flex gap-2 align-items-center">
                <div class="input-group">
                    <input type="number" class="form-control" value="90" placeholder="Min">
                    <span class="input-group-text">min</span>
                </div>
                <span>to</span>
                <div class="input-group">
                    <input type="number" class="form-control" value="180" placeholder="Max">
                    <span class="input-group-text">min</span>
                </div>
            </div>
        </div>

        <div class="filter-section">
            <h5>Number of Tickets</h5>
            <div class="ticket-counter">
                <button>-</button>
                <span id="ticketCount">5</span>
                <button>+</button>
            </div>
        </div>

        <div class="filter-section" style="background-color: #c1bbd6;">
            <h5>Your Name</h5>
            <input type="text" id="userName" class="form-control" placeholder="Enter your name" value="User">
        </div>

        <div class="buttons-container">
            <button class="btn btn-primary" id="filterButton">Apply Filters</button>
            <button class="btn btn-submit" id="submitButton">Submit Selection</button>
        </div>
    </div>

    <div id="header">
        <h1>Movies</h1>
    </div>

    <div id="main-content">
        <div class="row" id="movieGrid">
            <!-- Static movie cards removed - dynamically generated from Judge data -->
            <div class="col-12 text-center p-5">
                <div class="spinner-border text-secondary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Loading movies...</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize the Judge with your team name
        const judge = new Judge("SoGiChi");
        
        // Get all movies from the framework (data retrieved from the server)
        let movies = [];
        let filteredMovies = [];
        let currentlySelectedMovie = null;
        let currentlySelectedTime = null;

        // Initialize after the framework has loaded the movies
        window.addEventListener('DOMContentLoaded', () => {
            // Get movies from the Judge framework
            movies = judge.getMovies();
            console.log("Loaded movies from server:", movies.length);
            
            // Set initial values
            filteredMovies = [...movies];
            if (movies.length > 0) {
                currentlySelectedMovie = movies[0];
                currentlySelectedTime = movies[0].movieTimes[0];
            }
            
            // Initialize the UI with the movie data
            initUI();
        });
        
        // Add submission event handler
        judge.on("submission", data => {
            // "data" will include: 
            // userData (containing the data we just sent to the Judge), teamName, and elapsedTime (since page load)
            console.log("Time elapsed: " + data.elapsedTime);
        });
        
        // DOM elements
        const ticketCountEl = document.getElementById("ticketCount");
        const filterButton = document.getElementById("filterButton");
        const submitButton = document.getElementById("submitButton");
        const ticketBtns = document.querySelectorAll(".ticket-counter button");
        const featureToggle = document.getElementById("featureToggle");
        const featureSelect = document.getElementById("featureSelect");
        const includeList = document.getElementById("includeList");
        const excludeList = document.getElementById("excludeList");
        const movieGrid = document.getElementById("movieGrid");
        const runtimeInputs = document.querySelectorAll('input[type="number"]');
        const addTimeRangeBtn = document.querySelector('.filter-section button.btn-secondary');
        const timeRangesContainer = document.getElementById("timeRanges");
        
        // Initialize UI with actual movie data
        function initUI() {
            // Clear existing genre and actor checkboxes
            includeList.innerHTML = '';
            excludeList.innerHTML = '';
            
            // Set up genre or actor filtering based on current selection
            updateFeatureLists();
            
            // Populate movie grid with all movies
            updateMovieGrid(movies);
            
            // Add event listener to toggle between genres and actors
            featureSelect.addEventListener('change', updateFeatureLists);
        }
        
        // Update feature lists based on selection (genres or actors)
        function updateFeatureLists() {
            // Clear existing checkboxes
            includeList.innerHTML = '';
            excludeList.innerHTML = '';
            
            const featureType = featureSelect.value; // 'genre' or 'actors'
            
            if (featureType === 'genre') {
                // Get all unique genres from movies
                const genres = new Set();
                movies.forEach(movie => {
                    movie.genres.forEach(genre => genres.add(genre));
                });
                
                // Add genre checkboxes
                let i = 0;
                genres.forEach(genre => {
                    const includeItem = createCheckboxItem(genre, `include-genre-${i}`, true);
                    includeList.appendChild(includeItem);
                    
                    const excludeItem = createCheckboxItem(genre, `exclude-genre-${i}`, false);
                    excludeList.appendChild(excludeItem);
                    i++;
                });
            } else if (featureType === 'actors') {
                // Get all unique actors from movies
                const actors = new Set();
                movies.forEach(movie => {
                    movie.actors.forEach(actor => actors.add(actor));
                });
                
                // Add actor checkboxes
                let i = 0;
                actors.forEach(actor => {
                    const includeItem = createCheckboxItem(actor, `include-actor-${i}`, false);
                    includeList.appendChild(includeItem);
                    
                    const excludeItem = createCheckboxItem(actor, `exclude-actor-${i}`, false);
                    excludeList.appendChild(excludeItem);
                    i++;
                });
            }
        }
        
        // Create a checkbox item
        function createCheckboxItem(label, id, checked) {
            const div = document.createElement('div');
            div.className = 'checkbox-item';
            
            const input = document.createElement('input');
            input.type = 'checkbox';
            input.id = id;
            if (checked) input.checked = true;
            
            const labelEl = document.createElement('label');
            labelEl.htmlFor = id;
            labelEl.textContent = label;
            
            div.appendChild(input);
            div.appendChild(labelEl);
            return div;
        }
        
        // Update movie grid with filtered movies
        function updateMovieGrid(moviesToShow) {
            movieGrid.innerHTML = '';
            
            moviesToShow.forEach(movie => {
                const card = document.createElement('div');
                card.className = 'movie-card';
                
                // Create card header with title and description
                const header = document.createElement('div');
                header.className = 'movie-card-header';
                
                const title = document.createElement('div');
                title.className = 'movie-title';
                title.textContent = movie.title;
                
                const description = document.createElement('div');
                description.className = 'movie-description';
                description.textContent = movie.description;
                
                header.appendChild(title);
                header.appendChild(description);
                
                // Create details section with runtime, genres and cast
                const details = document.createElement('div');
                details.className = 'movie-details';
                
                const info = document.createElement('div');
                info.className = 'movie-info';
                
                const runtime = document.createElement('div');
                runtime.className = 'movie-runtime';
                runtime.textContent = `${movie.movieLength} min`;
                
                const genresTitle = document.createElement('div');
                genresTitle.className = 'movie-genres-title';
                genresTitle.textContent = 'Genres:';
                
                const genres = document.createElement('div');
                genres.className = 'movie-genres';
                genres.textContent = movie.genres.join(', ');
                
                info.appendChild(runtime);
                info.appendChild(genresTitle);
                info.appendChild(genres);
                
                // Add info to details, but handle cast separately
                details.appendChild(info);
                
                // Create showtimes section
                const showtimes = document.createElement('div');
                showtimes.className = 'showtime-buttons';
                
                // Use the filtered showtimes if available, otherwise use all showtimes
                const timesToShow = movie.validShowtimes || movie.movieTimes;
                
                timesToShow.forEach(time => {
                    const button = document.createElement('button');
                    button.className = 'showtime-button';
                    
                    // Convert military time to AM/PM format
                    const formattedTime = formatTimeToAMPM(time);
                    button.textContent = formattedTime;
                    button.dataset.originalTime = time; 
                    
                    // Add click event for showtime selection
                    button.addEventListener('click', () => {
                        // Store selected movie and time 
                        currentlySelectedMovie = movie;
                        currentlySelectedTime = time; 
                        
                        // Highlight selected button
                        document.querySelectorAll('.showtime-button.selected').forEach(btn => {
                            btn.classList.remove('selected');
                            btn.style.backgroundColor = '#805ad5';
                        });
                        button.classList.add('selected');
                        button.style.backgroundColor = '#3182ce'; 
                        
                        console.log('Selected:', movie.title, time);
                    });
                    
                    showtimes.appendChild(button);
                });
                
                // Create cast section 
                const cast = document.createElement('div');
                cast.className = 'movie-cast';
                
                const castTitle = document.createElement('div');
                castTitle.className = 'movie-cast-title';
                castTitle.textContent = 'Starring:';
                
                const castList = document.createElement('div');
                castList.className = 'movie-cast-list';
                castList.textContent = movie.actors.join(', ');
                
                cast.appendChild(castTitle);
                cast.appendChild(castList);
                
                // Assemble card with new structure
                card.appendChild(header);
                card.appendChild(details); // Contains only the left-side info now
                card.appendChild(cast); // Now directly in card for absolute positioning
                card.appendChild(showtimes);
                
                movieGrid.appendChild(card);
            });
            
            if (moviesToShow.length === 0) {
                const noResults = document.createElement('div');
                noResults.textContent = 'No movies match your filters.';
                noResults.style.padding = '20px';
                noResults.style.textAlign = 'center';
                movieGrid.appendChild(noResults);
            }
        }
        
        // Format time from 24-hour to AM/PM format
        function formatTimeToAMPM(time) {
            if (!time) return '';
            
            let [hours, minutes] = time.split(':');
            hours = parseInt(hours);
            
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12; 
            
            return `${hours}:${minutes} ${ampm}`;
        }
        
        // Parse AM/PM time back to 24-hour format for filtering
        function parseTimeToMilitary(timeStr) {
            if (!timeStr) return '';
            
            const [timePart, ampm] = timeStr.split(' ');
            let [hours, minutes] = timePart.split(':');
            hours = parseInt(hours);
            
            if (ampm === 'PM' && hours < 12) hours += 12;
            if (ampm === 'AM' && hours === 12) hours = 0;
            
            return `${hours.toString().padStart(2, '0')}:${minutes}`;
        }
        
        // Filter by time ranges 
        function getTimeRanges() {
            const timeRanges = [];
            
            document.querySelectorAll('.time-range').forEach(range => {
                const timeInputs = range.querySelectorAll('.time-input');
                if (timeInputs.length >= 2) {
                    const startInput = timeInputs[0];
                    const endInput = timeInputs[1];
                    const startTime = startInput.querySelector('.time-field').value;
                    const endTime = endInput.querySelector('.time-field').value;
                    
                    // Get AM/PM toggles
                    const startToggle = startInput.querySelector('.ampm-toggle');
                    const endToggle = endInput.querySelector('.ampm-toggle'); 
                    
                    if (startToggle && endToggle) {
                        const startAMPM = startToggle.dataset.period;
                        const startIsActive = startToggle.classList.contains('active');
                        const endAMPM = endToggle.dataset.period;
                        const endIsActive = endToggle.classList.contains('active');
                        
                        // Create time range objects
                        let start = null;
                        let end = null;
                        
                        // Only process start time if it exists and toggle is active
                        if (startTime && startIsActive) {
                            let [startHours, startMinutes] = startTime.split(':');
                            start = convertTo24HourFormat(startHours, startMinutes, startAMPM);
                        }
                        
                        // Only process end time if it exists and toggle is active
                        if (endTime && endIsActive) {
                            let [endHours, endMinutes] = endTime.split(':');
                            end = convertTo24HourFormat(endHours, endMinutes, endAMPM);
                        }
                        
                        // Add to ranges if at least one of start or end exists
                        if (start !== null || end !== null) {
                            timeRanges.push({ start, end });
                        }
                    }
                }
            });
            
            return timeRanges;
        }
        
        // Convert hours, minutes, and period to 24-hour format
        function convertTo24HourFormat(hours, minutes, period) {
            hours = parseInt(hours, 10);
            minutes = parseInt(minutes, 10);
            
            if (period === 'PM' && hours < 12) {
                hours += 12;
            } else if (period === 'AM' && hours === 12) {
                hours = 0;
            }
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }
        
        // Update filterMovies function for the new time range handling
        function filterMovies() {
            let result = [...movies];
            
            // Filter by tickets
            const ticketCount = parseInt(ticketCountEl.textContent);
            
            // Filter by runtime
            const minRuntime = parseInt(runtimeInputs[0].value) || 0;
            const maxRuntime = parseInt(runtimeInputs[1].value) || Infinity;
            result = result.filter(movie => {
                return movie.movieLength >= minRuntime && movie.movieLength <= maxRuntime;
            });
            
            // Get time ranges for filtering
            const timeRanges = getTimeRanges();
            
            // Track valid showtimes
            if (timeRanges.length > 0) {
                result.forEach(movie => {
                    const validShowtimes = [];
                    
                    // Check each showtime
                    movie.movieTimes.forEach(time => {
                        // Calculate when the movie will end by adding its runtime
                        const endTimeMinutes = calculateEndTimeMinutes(time, movie.movieLength);
                        const startTimeMinutes = convertTimeToMinutes(time);
                        
                        // Default to valid 
                        let isValid = false;
                        
                        // A showtime passes if it satisfies at least one of the time ranges
                        isValid = timeRanges.some(range => {
                            // Handle open-ended ranges
                            const rangeStartMinutes = range.start ? convertTimeToMinutes(range.start) : 0; // Default to start of day
                            const rangeEndMinutes = range.end ? convertTimeToMinutes(range.end) : 24 * 60 - 1; // Default to end of day
                            
                            // If only start time provided: movie must start after specified time
                            if (range.start && !range.end) {
                                return startTimeMinutes >= rangeStartMinutes;
                            }
                            
                            // If only end time provided: movie must end before specified time
                            if (!range.start && range.end) {
                                return endTimeMinutes <= rangeEndMinutes;
                            }
                            
                            // Check if this is an overnight range (crossing midnight)
                            const isOvernightRange = rangeEndMinutes < rangeStartMinutes;
                            
                            if (isOvernightRange) {
                                // For overnight ranges, the movie should either:
                                // Start after the range start and before midnight, or
                                // Start after midnight and before the range end
                                return (startTimeMinutes >= rangeStartMinutes) || 
                                       (startTimeMinutes <= rangeEndMinutes);
                            } else {
                                // For regular ranges, movie must start between start and end times
                                return startTimeMinutes >= rangeStartMinutes && startTimeMinutes <= rangeEndMinutes;
                            }
                        });
                        
                        if (isValid) {
                            validShowtimes.push(time);
                        }
                    });
                    
                    // Store the filtered showtimes on the movie object
                    movie.validShowtimes = validShowtimes;
                });
                
                // Only filter out movies that have no valid showtimes left
                result = result.filter(movie => movie.validShowtimes.length > 0);
            } else {
                // If no time filters, all showtimes are valid
                result.forEach(movie => {
                    movie.validShowtimes = [...movie.movieTimes];
                });
            }
            
            // Get the current feature type for filtering
            const featureType = featureSelect.value; // genre or actors
            
            // Get checked items from include and exclude lists
            const includeItems = [];
            const excludeItems = [];
            
            includeList.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                includeItems.push(checkbox.nextElementSibling.textContent);
            });
            
            excludeList.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                excludeItems.push(checkbox.nextElementSibling.textContent);
            });
            
            // Apply feature filtering based on type
            if (featureType === 'genre') {
                // Filter by genres
                if (includeItems.length > 0) {
                    result = result.filter(movie => {
                        return movie.genres.some(genre => includeItems.includes(genre));
                    });
                }
                
                if (excludeItems.length > 0) {
                    result = result.filter(movie => {
                        return !movie.genres.some(genre => excludeItems.includes(genre));
                    });
                }
            } else if (featureType === 'actors') {
                // Filter by actors
                if (includeItems.length > 0) {
                    result = result.filter(movie => {
                        return movie.actors.some(actor => includeItems.includes(actor));
                    });
                }
                
                if (excludeItems.length > 0) {
                    result = result.filter(movie => {
                        return !movie.actors.some(actor => excludeItems.includes(actor));
                    });
                }
            }
            
            return result;
        }
        
        // Calculate the end time of a movie in minutes since midnight
        function calculateEndTimeMinutes(startTime, durationMinutes) {
            // Convert start time to minutes since midnight
            const startMinutes = convertTimeToMinutes(startTime);
            // Add the movie duration
            return startMinutes + durationMinutes;
        }
        
        // Convert time string (HH:MM) to minutes since midnight
        function convertTimeToMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }
        
        // Ticket counter functionality
        ticketBtns[0].addEventListener('click', () => {
            let count = parseInt(ticketCountEl.textContent);
            if (count > 1) {
                ticketCountEl.textContent = count - 1;
            }
        });
        
        ticketBtns[1].addEventListener('click', () => {
            let count = parseInt(ticketCountEl.textContent);
            ticketCountEl.textContent = count + 1;
        });
        
        // Add time range functionality
        addTimeRangeBtn.addEventListener('click', () => {
            const rangeCount = document.querySelectorAll('.time-range').length + 1;
            const newRange = document.createElement('div');
            newRange.className = 'time-range';
            newRange.innerHTML = `
                <div class="time-input">
                    <input type="text" class="time-field" pattern="([1-9]|1[0-2]):[0-5][0-9]" placeholder="From">
                    <button class="ampm-toggle active" data-period="AM">AM</button>
                </div>
                <span>to</span>
                <div class="time-input">
                    <input type="text" class="time-field" pattern="([1-9]|1[0-2]):[0-5][0-9]" placeholder="To">
                    <button class="ampm-toggle" data-period="PM">PM</button>
                </div>
                <button class="btn btn-danger btn-sm">×</button>
            `;
            
            // Add event listener to delete button
            newRange.querySelector('.btn-danger').addEventListener('click', (e) => {
                e.target.closest('.time-range').remove();
            });
            
            // Add event listeners to AM/PM toggle buttons
            newRange.querySelectorAll('.ampm-toggle').forEach(btn => {
                btn.addEventListener('click', toggleAMPM);
            });
            
            timeRangesContainer.appendChild(newRange);
        });
        
        // Add event listener to initial delete buttons
        document.querySelectorAll('.time-range .btn-danger').forEach(btn => {
            btn.addEventListener('click', (e) => {
                if (document.querySelectorAll('.time-range').length > 1) {
                    e.target.closest('.time-range').remove();
                }
            });
        });
        
        // AM/PM toggle functionality
        function toggleAMPM(e) {
            const button = e.target;
            button.classList.toggle('active');
            
            // Toggle between AM and PM
            if (button.dataset.period === 'AM') {
                button.dataset.period = 'PM';
                button.textContent = 'PM';
            } else {
                button.dataset.period = 'AM';
                button.textContent = 'AM';
            }
        }
        
        // Add event listeners to initial AM/PM toggle buttons
        document.querySelectorAll('.ampm-toggle').forEach(btn => {
            btn.addEventListener('click', toggleAMPM);
        });
        
        // Apply filters button
        filterButton.addEventListener('click', () => {
            filteredMovies = filterMovies();
            updateMovieGrid(filteredMovies);
        });
        
        // Submit button click handler 
        submitButton.addEventListener('click', () => {
            // Check if a showtime has been selected
            const selectedShowtime = document.querySelector('.showtime-button.selected');
            if (!selectedShowtime) {
                alert("Please select a showtime before submitting.");
                return;
            }
            
            // When user clicks submit, bundle up the data and submit it
            const ticketCount = parseInt(ticketCountEl.textContent);
            const userName = document.getElementById("userName").value || "User";
            
            // Metadata for the Judge
            const userData = {
                movie: currentlySelectedMovie, 
                movieTime: currentlySelectedTime, 
                numberOfTickets: ticketCount, 
                userName: userName
            };
            
            // Log the submission
            console.log('Submitting:', currentlySelectedMovie.title, currentlySelectedTime, ticketCount, 'tickets for', userName);
            
            // Successful submission alert 
            const formattedTime = formatTimeToAMPM(currentlySelectedTime);
            alert(`Thank you, ${userName}! Your selection of ${ticketCount} ticket(s) for "${currentlySelectedMovie.title}" at ${formattedTime} has been submitted successfully.`);
            
            // Visual feedback
            submitButton.textContent = "Submitted!";
            submitButton.classList.add("btn-success");
            submitButton.disabled = true;
            
            // Reset after a short delay
            setTimeout(() => {
                submitButton.textContent = "Submit Selection";
                submitButton.classList.remove("btn-success");
                submitButton.disabled = false;
            }, 5000);
            
            // Submit it to the Judge 
            judge.submitMovieChoice(userData);
        });
        
        // Toggle include/exclude feature
        featureToggle.addEventListener('change', () => {
            if (featureToggle.checked) {
                includeList.style.display = 'none';
                excludeList.style.display = 'block';
            } else {
                includeList.style.display = 'block';
                excludeList.style.display = 'none';
            }
        });
        
        // Initialize
        excludeList.style.display = 'none'; // Hide exclude list initially
        initUI(); // Initialize UI with movie data
    </script>
</body>
</html> 